<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Busqueda Avanzada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/docsify@4.12.1/themes/vue.css"/>
  <link rel="stylesheet" href="custom.css"/>
  <style>
  #search-form { margin:20px; }
  #results ul { list-style:none; padding:0; }
  #results li { margin-bottom:10px; }
  </style>
</head>
<body>
  <div id="search-form">
    <input type="text" id="query" placeholder="TÃ©rmino" />
    <input type="text" id="source" placeholder="source_file" />
    <input type="date" id="date" />
    <select id="level">
      <option value="">Nivel</option>
      <option value="2">H2</option>
      <option value="3">H3</option>
      <option value="4">H4</option>
    </select>
    <button id="btn-search">Buscar</button>
  </div>
  <div id="results"></div>

  <script src="https://unpkg.com/lunr/lunr.js"></script>
  <script>
    let idx; let headerIdx; let docs = []; let headers = [];

    async function init() {
      const res = await fetch('search_index.json');
      const json = await res.json();
      docs = Object.entries(json).map(([id, info]) => {
        const meta = info.metadata || {};
        return {
          id: id,
          url: 'index.html#/' + id.replace(/\.md$/, ''),
          content: info.content || '',
          source_file: meta.source_file || '',
          conversion_date: meta.conversion_date || ''
        };
      });
      headers = Object.entries(json).flatMap(([id, info]) =>
        (info.headers || []).map(h => ({
          ref: id + '#' + h.slug,
          header: h.text,
          level: h.level,
          url: 'index.html#/' + id.replace(/\.md$/, '') + '#' + h.slug
        }))
      );

      idx = lunr(function() {
        this.ref('id');
        this.field('content');
        this.field('source_file');
        this.field('conversion_date');
        docs.forEach(d => this.add(d));
      });
      headerIdx = lunr(function() {
        this.ref('ref');
        this.field('header');
        headers.forEach(h => this.add(h));
      });
    }

    function doSearch() {
      const q = document.getElementById('query').value;
      const source = document.getElementById('source').value.toLowerCase();
      const date = document.getElementById('date').value;
      const level = document.getElementById('level').value;
      let res = q ? idx.search(q) : docs.map(d => ({ ref: d.id }));
      res = res.map(r => docs.find(d => d.id === r.ref));
      res = res.filter(d => (!source || d.source_file.toLowerCase().includes(source)) &&
                            (!date || d.conversion_date === date));
      let headerRes = q ? headerIdx.search(q) : headers.map(h => ({ ref: h.ref }));
      headerRes = headerRes.map(r => headers.find(h => h.ref === r.ref));
      headerRes = headerRes.filter(h => (!level || String(h.level) === level));

      const listDocs = res.map(d => `<li><a href="${d.url}">${d.id}</a>`+
         ` <small>${d.source_file} - ${d.conversion_date}</small></li>`).join('');
      const listHeaders = headerRes.map(h => `<li><a href="${h.url}">${h.header}</a>`+
         ` <small>(H${h.level})</small></li>`).join('');
      const html = `<h3>Documentos</h3><ul>${listDocs}</ul><h3>Encabezados</h3><ul>${listHeaders}</ul>`;
      document.getElementById('results').innerHTML = html;
    }

    document.getElementById('btn-search').addEventListener('click', doSearch);
    document.getElementById('query').addEventListener('input', doSearch);
    init();
  </script>
  <script src="copy-button.js"></script>
</body>
</html>
